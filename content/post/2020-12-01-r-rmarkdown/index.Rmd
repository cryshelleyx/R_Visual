---
title: "Hello R Markdown"
author: "Frida Gomam"
date: '2020-12-01T21:13:14-05:00'
categories: R
tags:
- R Markdown
- plot
- regression
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# 1 Overview 


## 1.1 Background of the case

Mini-Challenge 2 is to analyze movement and tracking data. GAStech provides many of their employees with company cars for their personal and professional use, but unbeknownst to the employees, the cars are equipped with GPS tracking devices. You are given tracking data for the two weeks leading up to the disappearance, as well as credit card transactions and loyalty card usage data. From this data, can you identify anomalies and suspicious behaviors? Can you identify which people use which credit and loyalty cards?


## 1.2 Literature Review / Motivation

Inspired by the 2014 VAST Challenge, I have learned many techniques from the previous submission. For example, Central South University has used the choropleth map to reveal the interaction between Employee, location as well as time elements. 

![](image/Picture5.png)


Most of the submissions also use map trajectories to detect the users of the credit card by matching traveling patterns and staying locations.

However, it is often the case that the visuals are not interactive hence the readers might be affected by the resolution of the image and size of the fonts. 

Therefore, this write-up will help to provide more interactive plots to enable the ease of interactivity in visual analytics.


# 2 Data Description and Preparation

* First of all, we need to load the necessary packages to the environment. 


```{r, echo = TRUE}

packages = c( 'clock','raster', 'sf', 'tmap', 'tidyverse', 'stringi', 'plotly', 'DT', 'patchwork','readxl', 'Rcpp', 'lubridate')

for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  
  library(p, character.only = T)
}
```

* The datasets are loaded using read_csv.
* The locationMapping.csv was created to categorise locations 'F&B', 'Work' and 'Lifestyle'.


```{r, echo = TRUE}
# read data in 
cc <- read_csv('MC2\\cc_data.csv')
loyalty <- read_csv('MC2\\loyalty_data.csv')
locationmapping <- read_csv('MC2\\LocationMapping.csv')
ap <- raster("C:\\Study\\MITB Term 3\\ISSS608 Visual Analytics\\Lesson08\\In-class_Ex08\\Geospatial\\MC2-tourist.tif")
gps <- read_csv('MC2\\gps.csv')

```

* Data Cleaning: 
* Convert the timestamp of the datasets into proper time format.
* Remove the special characters of location names


```{r, echo = TRUE}
cc$timestamp <- date_time_parse(cc$timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y %H:%M")

loyalty$timestamp <- as.Date(loyalty$timestamp, 
                             format="%m/%d/%Y")

cc$date <- as.Date(cc$timestamp, 
                   format="%m/%d/%Y")
cc$location <- stri_trans_general(cc$location, 
                         
         "latin-ascii")
loyalty$location <- stri_trans_general(loyalty$location,
                                       "latin-ascii")
locationmapping$Location <- stri_trans_general(locationmapping$Location,
                                       "latin-ascii")

datatable(locationmapping)

```


Data Preprocessing 

```{r}
#join the dataset cc-data.csv and loyalty_data.csv by date, location and price
cc <- left_join(cc,locationmapping,
                by = c('location' = "Location"))
df1 <- left_join(cc, loyalty,
                 by = c('date' = 'timestamp','location', 'price'))


#adding features of the data
df1$hour <- strftime(df1$timestamp, format = "%H")
df1$datehour <- strftime(df1$timestamp, format = "%d-%H")
df1$period <- cut(as.numeric(df1$hour),
                  breaks = c(0,5,11,14,19,20,23),
                  labels = c("midnight",
                             "morning",
                             "lunch",
                             "afternoon",
                             "dinner",
                             "nignt"))

#df1$location <- stri_trans_general(df1$location, "latin-ascii")

df1$last4ccnum <- as_factor(df1$last4ccnum)
df1$loyaltynum <- as_factor(df1$loyaltynum)



```

# Question 1
Using just the credit and loyalty card data, identify the most popular locations, and when they are popular. What anomalies do you see? What corrections would you recommend correcting these anomalies? Please limit your answer to 8 images and 300 words.

* The most popular spots are mostly coffee cafes such as Brew've Been Served, Bean There Done That, Hallowed Grounds, etc. 

* Eateries have quite high visits as well. Katerina's Cafe is the highest in terms of spending records of 214 times. Hippokampos aslo have very high visits. 

```{r}
#The top few spots by visit 
df_sum <- df1 %>%
  group_by(location) %>%
  summarise(count = n())

plot1 <- ggplot(df_sum, 
                aes(x = reorder(location, count), 
                    y = count,
                    text = paste("<br>", "Count: ", count))
                )+
  geom_bar(stat = "identity",
           color = "black",
           fill = "lightblue") +
  coord_flip() 

ggplotly(plot1,
         tooltip = c('text'), height = 600, width = 800) 


```




Location visits by the time period

* For the coffee cafes, Brew've Been Saved is only visited in the morning. While Thes rest are all visited during the lunch hours.

* Katerina has high visits during lunch and dinner hours, it also has some visits during late night and afternoon hours

* More people visited Hippokampos during the morning hours.



```{r}
#location visit by the time period 
df3 <- df1 %>%
  group_by(location, period) %>%
  summarise(n = n())

plot2 <- ggplot(df3,
                aes(x = n,
                    y = location)) +
  geom_bar(stat = "identity",
           color = "black") +
  geom_col(aes(fill = period)) + 
  scale_fill_brewer(palette = "Spectral") +
  theme_light()

ggplotly(plot2, height = 600, width = 800)
```


For a more detailed breakdown, the individual graphs of each coffee cafe is ploted. It is observed that 

```{r}
#credit card by hour and location 
#library(devtools)
#("thomasp85/patchwork")
#library(patchwork)
list <- c("Kronos Mart", "Bean There Done That", "Brewed Awakenings","Jack's Magical Beans")

df2 <- df1 %>%
  group_by(location, hour) %>%
  summarise(n = n())

p1 <-
       ggplot(df2[df2$location =="Brewed Awakenings",],
       aes(x = hour, y = n)) +
       geom_bar(stat = "identity",
                  color = "black",
                  fill = "lightblue") + 
    ggtitle("Brewed Awakenings")

  p2 <-
       ggplot(df2[df2$location =="Bean There Done That",],
       aes(x = hour, y = n)) +
       geom_bar(stat = "identity",
                  color = "black",
                  fill = "lightblue") + 
    ggtitle("Bean There Done That")

  p3 <-
       ggplot(df2[df2$location =="Jack's Magical Beans",],
       aes(x = hour, y = n)) +
       geom_bar(stat = "identity",
                  color = "black",
                  fill = "lightblue") + 
    ggtitle("Jack's Magical Beans")
  
  
  p4 <-
       ggplot(df2[df2$location =="Brew've Been Served",],
       aes(x = hour, y = n)) +
       geom_bar(stat = "identity",
                  color = "black",
                  fill = "lightblue") + 
    ggtitle("Brew've Been Served")
  
  (p1 + p2)/(p3+p4)
```

transaction boxplot by location 

Some outliers are revealed by the 

```{r}
ggplotly(
  ggplot(df1[df1$Category == 'F&B',], aes(x = location,
                y = price,
                #group = Category,
                color = location,
                text = paste("Price: ", price, "<br>", "CC: ", last4ccnum, "<br>", "Timestamp: ", timestamp))) + 
    #facet_grid(rows = vars(Category)) + 
    geom_jitter(size = 0.5) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)),
  tooltip = c('text')
)

```

```{r}
ggplotly(
  ggplot(df1[df1$Category == 'Life',], aes(x = location,
                y = price,
                #group = Category,
                color = location,
                text = paste("Price: ", price, "<br>", "CC: ", last4ccnum, "<br>", "Timestamp: ", timestamp))) + 
    #facet_grid(rows = vars(Category)) + 
    geom_jitter(size = 0.5) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)),
  tooltip = c('text')
)
```

```{r}
ggplotly(
  ggplot(df1[df1$Category == 'Work',], aes(x = location,
                y = price,
                #group = Category,
                color = location,
                text = paste("Price: ", price, "<br>", "CC: ", last4ccnum, "<br>", "Timestamp: ", timestamp))) + 
    #facet_grid(rows = vars(Category)) + 
    geom_jitter(size = 0.5) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)),
  tooltip = c('text')
)
```









* Katerina has high visits during lunch and dinner hours, it also has some visits during late night and afternoon hours

* More people visited Hippokampos during the morning hours.












